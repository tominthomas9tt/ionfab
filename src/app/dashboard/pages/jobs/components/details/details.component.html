<ion-content color="light">
    <div>
        <ion-grid fixed>
            <ion-row>
                <ion-col size="12">
                    <app-back [title]="'Job Details'"></app-back>
                </ion-col>
            </ion-row>
            <ion-row class="ion-justify-content-center">
                <ion-col align-self-center>
                    <app-loading [isLoading]="isLoading"></app-loading>
                    <div class="borderWithBackground ion-padding shadow">
                        <ion-row class="section-title">
                            <ion-col size="10">
                                <ion-card-subtitle>Job basic Details</ion-card-subtitle>
                            </ion-col>
                            <ion-col size="2">
                                <ion-button (click)="getTenderDetails()">
                                    <ion-icon slot="icon-only" name="refresh">
                                    </ion-icon>
                                </ion-button>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col><span class="head">Title</span>: {{detailData?.title}}</ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12" size-md="6">
                                <ion-row>
                                    <ion-col class="head">Job No</ion-col>
                                    <ion-col>: {{detailData?.tenderNo}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Date</ion-col>
                                    <ion-col>: {{detailData?.date|date}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Job Date</ion-col>
                                    <ion-col>: {{detailData?.jobDate|date}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Job Time</ion-col>
                                    <ion-col>: {{detailData?.jobTime}}</ion-col>
                                </ion-row>
                            </ion-col>
                            <ion-col size="12" size-md="6">
                                <ion-row>
                                    <ion-col class="head">Service</ion-col>
                                    <ion-col>: {{detailData?.serviceName}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Description</ion-col>
                                    <ion-col>: {{detailData?.description}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Inspection required</ion-col>
                                    <ion-col>: {{detailData?.isInspectionRequired==2?"Yes":"No"}}</ion-col>
                                </ion-row>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col class="head">Status :
                                <ion-label color="primary">
                                    {{(status?.customerMessage)?status?.customerMessage:status?.message}}
                                    <div *ngIf="status?.id == 16 && workorder && workorder?.isSuspected && workorder?.isSuspected==2">
                                        Workorder changes has been quoted. Accept changes to proceed.
                                    </div>
                                </ion-label>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12">
                                <small><i>Last updated:</i> {{dateFormat(detailData?.updatedAt)}}</small>
                            </ion-col>
                        </ion-row>
                        <!-- {{detailData|json}} -->
                        <div *ngIf="detailData?.status>21">
                            <ion-row class="section-title">
                                <ion-col size="12">
                                    <ion-card-subtitle>Review Details</ion-card-subtitle>
                                </ion-col>
                            </ion-row>
                            <ion-row *ngIf="!ratingReview">
                                <ion-col size="12">
                                    <p>
                                        <ion-label color="primary">To close the job please complete the following review form so that we can serve you better in future.</ion-label>
                                        <ion-button (click)="presentRatinReviewWindow()" shape="round">
                                            Rate and review
                                        </ion-button>
                                    </p>
                                </ion-col>
                            </ion-row>
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Rating</ion-col>
                                        <ion-col>: {{ratingReview?.rateOverall}}</ion-col>
                                    </ion-row>
                                </ion-col>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Review</ion-col>
                                        <ion-col>: {{ratingReview?.review}}</ion-col>
                                    </ion-row>
                                </ion-col>
                                <!-- {{ratingReview|json}} -->
                            </ion-row>
                        </div>
                        <div *ngIf="invoices && invoices.length>0">
                            <ion-row class="section-title">
                                <ion-col size="12">
                                    <ion-card-subtitle>Invoice Details</ion-card-subtitle>
                                </ion-col>
                            </ion-row>
                            <ion-row>
                                <ion-col size="12">
                                    <div style="overflow-x: auto;">
                                        <table mat-table [dataSource]="invoiceDataSource" class="mat-elevation-z8" matSort>
                                            <ng-container matColumnDef="slno">
                                                <th mat-header-cell *matHeaderCellDef> Sl No </th>
                                                <td mat-cell *matCellDef="let row;let i = index;"> {{i+1}} </td>
                                            </ng-container>
                                            <ng-container matColumnDef="docDtlsNo">
                                                <th mat-header-cell *matHeaderCellDef>Invoice No</th>
                                                <td mat-cell *matCellDef="let row"> {{row?.docDtlsNo}} </td>
                                            </ng-container>
                                            <ng-container matColumnDef="docDtlsDt">
                                                <th mat-header-cell *matHeaderCellDef>Invoice date</th>
                                                <td mat-cell *matCellDef="let row"> {{row?.docDtlsDt|date}} </td>
                                            </ng-container>
                                            <ng-container matColumnDef="amount">
                                                <th mat-header-cell *matHeaderCellDef>Amount</th>
                                                <td mat-cell *matCellDef="let row">
                                                    {{row?.valDtlsTotInvVal|indianCurrency}} </td>
                                            </ng-container>
                                            <ng-container matColumnDef="status">
                                                <th mat-header-cell *matHeaderCellDef>Status</th>
                                                <td mat-cell *matCellDef="let row">
                                                    <span *ngIf="row?.status && row?.status==3" style="color: green;">Completed</span>
                                                    <span *ngIf="row?.status && row?.status==2" style="color: red;">Pending</span>
                                                </td>
                                            </ng-container>
                                            <ng-container matColumnDef="actions">
                                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                                <td mat-cell *matCellDef="let row">
                                                    <ion-button (click)="makePaymentFor(row)" shape="round" *ngIf="row.status!=3">
                                                        Pay
                                                    </ion-button>
                                                </td>
                                            </ng-container>
                                            <tr mat-header-row *matHeaderRowDef="displayedInvoiceColumns"></tr>
                                            <tr mat-row *matRowDef="let row; columns: displayedInvoiceColumns;">
                                            </tr>
                                            <tr class="mat-row" *matNoDataRow>
                                                <td class="mat-cell" colspan="6">No records found.</td>
                                            </tr>
                                        </table>
                                    </div>
                                </ion-col>
                            </ion-row>
                            <!-- {{invoices|json}} -->
                        </div>
                    </div>
                    <div class="borderWithBackground ion-padding shadow up-arrow" *ngIf="workorder">
                        <ion-row class="section-title">
                            <ion-col size="12">
                                <ion-card-subtitle>Work order Details</ion-card-subtitle>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12" size-md="6">
                                <ion-row>
                                    <ion-col class="head">Work order No</ion-col>
                                    <ion-col>: {{workorder?.workorderNo}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Date</ion-col>
                                    <ion-col>: {{workorder?.date|date}}</ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col class="head">Amount</ion-col>
                                    <ion-col>: {{workorder?.amount|indianCurrency}}</ion-col>
                                </ion-row>
                                <ion-row *ngIf="workorder?.acceptedAt">
                                    <ion-col class="head">Accepted At</ion-col>
                                    <ion-col>: {{dateFormat(workorder?.acceptedAt)}}</ion-col>
                                </ion-row>
                                <ion-row *ngIf="workorder?.additionalAmount">
                                    <ion-col class="head">Additional Amount</ion-col>
                                    <ion-col>: {{workorder?.additionalAmount|indianCurrency}}</ion-col>
                                </ion-row>
                            </ion-col>
                            <ion-col size="12" size-md="6">
                                <ion-row *ngIf="workorder?.additionalAmountRemarks">
                                    <ion-col class="head">Reason for amount change</ion-col>
                                    <ion-col>: {{workorder?.additionalAmountRemarks}}</ion-col>
                                </ion-row>
                                <ion-row *ngIf="workorder?.totalAmount">
                                    <ion-col class="head">Total Amount</ion-col>
                                    <ion-col>: {{workorder?.totalAmount|indianCurrency}}</ion-col>
                                </ion-row>
                                <ion-row *ngIf="workorder?.completedAt">
                                    <ion-col class="head">Completed At</ion-col>
                                    <ion-col>: {{dateFormat(workorder?.completedAt)}}</ion-col>
                                </ion-row>
                                <ion-row *ngIf="workorder?.completedAcceptedAt">
                                    <ion-col class="head">Complete Acceptance At</ion-col>
                                    <ion-col>: {{dateFormat(workorder?.completedAcceptedAt)}}</ion-col>
                                </ion-row>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12">
                                <small><i>Last updated:</i> {{dateFormat(workorder?.updatedAt)}}</small>
                            </ion-col>
                        </ion-row>
                        <!-- {{workorder|json}} -->
                        <div *ngIf="workorder && workorder.isSuspected==2">
                            <ion-label color="primary">Work order amount has been changed.
                                <ion-button (click)="acceptWorkOrderChanges()" shape="round">
                                    Acccept Changes
                                </ion-button> to proceed.
                            </ion-label>

                        </div>
                        <div *ngIf="workorder && workorder.isCompleted==2 && workorder.isCompletedAccepted==1">
                            <ion-label color="primary">Work has been marked completed by the vendor.
                                <ion-button (click)="acceptWorkCompletion()" shape="round">
                                    Acccept work completion
                                </ion-button> to initiate final settlements.
                            </ion-label>

                        </div>

                    </div>
                    <div class="borderWithBackground ion-padding shadow up-arrow" *ngIf="(quotations && quotations.length>0) || selectedQuotation">
                        <ion-row class="section-title">
                            <ion-col size="12">
                                <ion-card-subtitle>Quotation Details</ion-card-subtitle>
                            </ion-col>
                        </ion-row>
                        <div *ngIf="quotations && !selectedQuotation">
                            <ion-row>
                                <ion-col size="12">
                                    <ion-list>
                                        <ion-item *ngFor="let quotation of quotations;let i=index;" class="ion-no-padding" lines="none">
                                            <ion-label>{{i+1}}. {{quotation.vendorName}}</ion-label>
                                            <ion-button (click)="viewQuotationDetails(quotation)" expand="block" fill="clear" shape="round">
                                                View
                                            </ion-button>
                                            <ion-button (click)="acceptQuotation(quotation)" expand="block" fill="clear" shape="round">
                                                Accept
                                            </ion-button>
                                        </ion-item>
                                    </ion-list>
                                </ion-col>
                            </ion-row>
                            <!-- {{quotations|json}} -->
                        </div>
                        <div *ngIf="selectedQuotation">
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Quotation No</ion-col>
                                        <ion-col>: {{selectedQuotation?.quotationNo}}</ion-col>
                                    </ion-row>
                                    <ion-row>
                                        <ion-col class="head">Date</ion-col>
                                        <ion-col>: {{selectedQuotation?.createdAt|date}}</ion-col>
                                    </ion-row>
                                    <ion-row>
                                        <ion-col class="head">Amount</ion-col>
                                        <ion-col>: {{selectedQuotation?.amount|indianCurrency}}</ion-col>
                                    </ion-row>
                                </ion-col>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Vendor</ion-col>
                                        <ion-col>: {{selectedQuotation?.vendorName}}</ion-col>
                                    </ion-row>
                                    <ion-row>
                                        <ion-col class="head">Scope of Work</ion-col>
                                        <ion-col>: {{selectedQuotation?.scopeOfWork}}</ion-col>
                                    </ion-row>
                                </ion-col>
                            </ion-row>
                            <ion-row>
                                <ion-col size="12">
                                    <ion-button *ngIf="detailData.status<15" (click)="generateWorkorder()" expand="block" fill="clear" shape="round">
                                        Generate workOrder
                                    </ion-button>
                                </ion-col>
                            </ion-row>
                            <!-- {{selectedQuotation|json}} -->
                        </div>
                    </div>
                    <div class="borderWithBackground ion-padding shadow up-arrow">
                        <!-- *ngIf="connectedVendors && connectedVendors.length>0 && !selectedQuotation && detailData.status>=12" -->
                        <ion-row class="section-title">
                            <ion-col size="12">
                                <ion-card-subtitle>Connected Vendors</ion-card-subtitle>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12">
                                <ion-list>
                                    <ion-item *ngFor="let vendor of connectedVendors;let i=index;" class="ion-no-padding" lines="none">
                                        <ion-label>{{i+1}}. {{vendor.vendorName}}</ion-label>
                                        <ion-button (click)="viewVendorDetails(vendor)" expand="block" fill="clear" shape="round">
                                            View
                                        </ion-button>
                                    </ion-item>
                                </ion-list>
                            </ion-col>
                        </ion-row>
                        <ion-row>
                            <ion-col size="12">
                                <div *ngIf="detailData?.status==12 && readyVendors && readyVendors?.length>0">
                                    <ion-label color="primary">
                                        <b>{{(readyVendors && readyVendors?.length)?readyVendors?.length:0}}</b> ready vendor(s).
                                    </ion-label>
                                    You'll get connected automatically upon atleast 5 ready vendors
                                    <p>OR</p>
                                    <ion-button (click)="triggerManualQuotations()" shape="round">
                                        Get connected
                                    </ion-button>
                                </div>
                            </ion-col>
                        </ion-row>
                        <!-- {{connectedVendors|json}} -->
                    </div>
                    <div class="borderWithBackground ion-padding shadow up-arrow" *ngIf="inspectionVendor || inspectionReport">
                        <ion-row class="section-title">
                            <ion-col size="12">
                                <ion-card-subtitle>Inspection Details</ion-card-subtitle>
                            </ion-col>
                        </ion-row>
                        <div *ngIf="inspectionVendor">
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Vendor</ion-col>
                                        <ion-col>: {{inspectionVendor?.vendorName}}</ion-col>
                                    </ion-row>
                                </ion-col>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Time</ion-col>
                                        <ion-col>: {{dateFormat(inspectionVendor?.connectedAt)}}</ion-col>
                                    </ion-row>
                                </ion-col>
                            </ion-row>
                            <!-- {{inspectionVendor|json}} -->
                        </div>
                        <div *ngIf="inspectionReport">
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Inspection No</ion-col>
                                        <ion-col>: {{inspectionReport?.inspectionNo}}</ion-col>
                                    </ion-row>
                                    <ion-row>
                                        <ion-col class="head">Inspected On</ion-col>
                                        <ion-col>: {{inspectionReport?.date|date}}</ion-col>
                                    </ion-row>
                                </ion-col>
                                <ion-col size="12" size-md="6">
                                    <ion-row>
                                        <ion-col class="head">Report</ion-col>
                                        <ion-col>: {{inspectionReport?.description}}</ion-col>
                                    </ion-row>
                                </ion-col>
                            </ion-row>
                            <!-- {{inspectionReport|json}} -->
                        </div>
                    </div>
                </ion-col>
            </ion-row>
        </ion-grid>
    </div>
</ion-content>